"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = authenticateRoutes;
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _joi = _interopRequireDefault(require("joi"));
var _asyncHandler = _interopRequireDefault(require("@global-common/server/routes/helper/asyncHandler"));
var _authenticateController = require("@diary-server/controller/authenticate-controller");
var _validator = require("@global-common/utils/validator");
var _utils = require("@global-common/server/routes/helper/utils");
var _userGuard = require("@diary-server/routes/middleware/userGuard");
var _makeJwt = require("@global-common/utils/make-jwt");
var _enum = require("@global-common/constants/enum");
var _user = require("@global-common/db/model/user");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function authenticateRoutes(router = (0, _express.Router)()) {
  // 다이어리 사용자 회원가입
  router.post('/diary/auth/join', (0, _asyncHandler.default)(postJoin));
  // 다이어리 사용자 로그인
  router.post('/diary/auth/login', (0, _asyncHandler.default)(postLogin));
  // 다이어리 사용자 로그아웃
  router.post('/diary/auth/logout', _userGuard.diaryGuard, (0, _asyncHandler.default)(postLogout));
  // 다이어리 사용자 신규 accessToken 발급
  router.put('/diary/auth/tokenRefresh', _userGuard.reissueGuard, (0, _asyncHandler.default)(putTokenRefresh));
  async function postJoin(req, res) {
    const body = (0, _validator.validateInputData)(req.body, {
      name: _joi.default.string().required(),
      email: _joi.default.string().required(),
      password: _joi.default.string().min(8).required(),
      gender: _joi.default.string().required().valid(..._lodash.default.values(_user.UserGender)),
      birthDate: _joi.default.date().required()
    });
    await (0, _authenticateController.userJoin)(body);
    (0, _utils.sendOk)(res);
  }
  async function postLogin(req, res) {
    const {
      email,
      password
    } = (0, _validator.validateInputData)(req.body, {
      email: _joi.default.string().email().required(),
      password: _joi.default.string().required()
    });
    const result = await (0, _authenticateController.userLogin)(email, password);
    res.json(result);
  }
  async function postLogout(req, res) {
    await (0, _authenticateController.userLogout)(req.user.id);
    (0, _utils.sendOk)(res);
  }
  async function putTokenRefresh(req, res) {
    const result = (0, _makeJwt.makeNewAccessToken)(req.user.id, _enum.UserType.Diary);
    res.json(result);
  }
  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhdXRoZW50aWNhdGVSb3V0ZXMiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJwb3N0IiwiYXN5bmNIYW5kbGVyIiwicG9zdEpvaW4iLCJwb3N0TG9naW4iLCJkaWFyeUd1YXJkIiwicG9zdExvZ291dCIsInB1dCIsInJlaXNzdWVHdWFyZCIsInB1dFRva2VuUmVmcmVzaCIsInJlcSIsInJlcyIsImJvZHkiLCJ2YWxpZGF0ZUlucHV0RGF0YSIsIm5hbWUiLCJKb2kiLCJzdHJpbmciLCJyZXF1aXJlZCIsImVtYWlsIiwicGFzc3dvcmQiLCJtaW4iLCJnZW5kZXIiLCJ2YWxpZCIsIl8iLCJ2YWx1ZXMiLCJVc2VyR2VuZGVyIiwiYmlydGhEYXRlIiwiZGF0ZSIsInVzZXJKb2luIiwic2VuZE9rIiwicmVzdWx0IiwidXNlckxvZ2luIiwianNvbiIsInVzZXJMb2dvdXQiLCJ1c2VyIiwiaWQiLCJtYWtlTmV3QWNjZXNzVG9rZW4iLCJVc2VyVHlwZSIsIkRpYXJ5Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2RpYXJ5LXNlcnZlci9yb3V0ZXMvZGVmYXVsdC1sb2FkL2F1dGhlbnRpY2F0ZS1yb3V0ZXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcydcclxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xyXG5pbXBvcnQgSm9pIGZyb20gJ2pvaSdcclxuXHJcbmltcG9ydCBhc3luY0hhbmRsZXIgZnJvbSAnQGdsb2JhbC1jb21tb24vc2VydmVyL3JvdXRlcy9oZWxwZXIvYXN5bmNIYW5kbGVyJ1xyXG5pbXBvcnQgeyB1c2VySm9pbiwgdXNlckxvZ2luLCB1c2VyTG9nb3V0IH0gZnJvbSAnQGRpYXJ5LXNlcnZlci9jb250cm9sbGVyL2F1dGhlbnRpY2F0ZS1jb250cm9sbGVyJ1xyXG5pbXBvcnQgeyB2YWxpZGF0ZUlucHV0RGF0YSB9IGZyb20gJ0BnbG9iYWwtY29tbW9uL3V0aWxzL3ZhbGlkYXRvcidcclxuaW1wb3J0IHsgc2VuZE9rIH0gZnJvbSAnQGdsb2JhbC1jb21tb24vc2VydmVyL3JvdXRlcy9oZWxwZXIvdXRpbHMnXHJcbmltcG9ydCB7IGRpYXJ5R3VhcmQsIHJlaXNzdWVHdWFyZCB9IGZyb20gJ0BkaWFyeS1zZXJ2ZXIvcm91dGVzL21pZGRsZXdhcmUvdXNlckd1YXJkJ1xyXG5pbXBvcnQgeyBtYWtlTmV3QWNjZXNzVG9rZW4gfSBmcm9tICdAZ2xvYmFsLWNvbW1vbi91dGlscy9tYWtlLWp3dCdcclxuaW1wb3J0IHsgVXNlclR5cGUgfSBmcm9tICdAZ2xvYmFsLWNvbW1vbi9jb25zdGFudHMvZW51bSdcclxuaW1wb3J0IHsgVXNlckdlbmRlciB9IGZyb20gJ0BnbG9iYWwtY29tbW9uL2RiL21vZGVsL3VzZXInXHJcblxyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBhdXRoZW50aWNhdGVSb3V0ZXMgKHJvdXRlciA9IFJvdXRlcigpKSB7XHJcbiAgLy8g64uk7J207Ja066asIOyCrOyaqeyekCDtmozsm5DqsIDsnoVcclxuICByb3V0ZXIucG9zdCgnL2RpYXJ5L2F1dGgvam9pbicsIGFzeW5jSGFuZGxlcihwb3N0Sm9pbikpXHJcbiAgLy8g64uk7J207Ja066asIOyCrOyaqeyekCDroZzqt7jsnbhcclxuICByb3V0ZXIucG9zdCgnL2RpYXJ5L2F1dGgvbG9naW4nLCBhc3luY0hhbmRsZXIocG9zdExvZ2luKSlcclxuICAvLyDri6TsnbTslrTrpqwg7IKs7Jqp7J6QIOuhnOq3uOyVhOybg1xyXG4gIHJvdXRlci5wb3N0KCcvZGlhcnkvYXV0aC9sb2dvdXQnLCBkaWFyeUd1YXJkLCBhc3luY0hhbmRsZXIocG9zdExvZ291dCkpXHJcbiAgLy8g64uk7J207Ja066asIOyCrOyaqeyekCDsi6Dqt5wgYWNjZXNzVG9rZW4g67Cc6riJXHJcbiAgcm91dGVyLnB1dCgnL2RpYXJ5L2F1dGgvdG9rZW5SZWZyZXNoJywgcmVpc3N1ZUd1YXJkLCBhc3luY0hhbmRsZXIocHV0VG9rZW5SZWZyZXNoKSlcclxuXHJcbiAgYXN5bmMgZnVuY3Rpb24gcG9zdEpvaW4gKHJlcSwgcmVzKSB7XHJcbiAgICBjb25zdCBib2R5ID0gdmFsaWRhdGVJbnB1dERhdGEocmVxLmJvZHksIHtcclxuICAgICAgbmFtZTogSm9pLnN0cmluZygpLnJlcXVpcmVkKCksXHJcbiAgICAgIGVtYWlsOiBKb2kuc3RyaW5nKCkucmVxdWlyZWQoKSxcclxuICAgICAgcGFzc3dvcmQ6IEpvaS5zdHJpbmcoKS5taW4oOCkucmVxdWlyZWQoKSxcclxuICAgICAgZ2VuZGVyOiBKb2kuc3RyaW5nKCkucmVxdWlyZWQoKS52YWxpZCguLi5fLnZhbHVlcyhVc2VyR2VuZGVyKSksXHJcbiAgICAgIGJpcnRoRGF0ZTogSm9pLmRhdGUoKS5yZXF1aXJlZCgpLFxyXG4gICAgfSlcclxuXHJcbiAgICBhd2FpdCB1c2VySm9pbihib2R5KVxyXG5cclxuICAgIHNlbmRPayhyZXMpXHJcbiAgfVxyXG5cclxuICBhc3luYyBmdW5jdGlvbiBwb3N0TG9naW4gKHJlcSwgcmVzKSB7XHJcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gdmFsaWRhdGVJbnB1dERhdGEocmVxLmJvZHksIHtcclxuICAgICAgZW1haWw6IEpvaS5zdHJpbmcoKS5lbWFpbCgpLnJlcXVpcmVkKCksXHJcbiAgICAgIHBhc3N3b3JkOiBKb2kuc3RyaW5nKCkucmVxdWlyZWQoKSxcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlckxvZ2luKGVtYWlsLCBwYXNzd29yZClcclxuXHJcbiAgICByZXMuanNvbihyZXN1bHQpXHJcbiAgfVxyXG5cclxuICBhc3luYyBmdW5jdGlvbiBwb3N0TG9nb3V0IChyZXEsIHJlcykge1xyXG4gICAgYXdhaXQgdXNlckxvZ291dChyZXEudXNlci5pZClcclxuXHJcbiAgICBzZW5kT2socmVzKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZnVuY3Rpb24gcHV0VG9rZW5SZWZyZXNoIChyZXEsIHJlcykge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gbWFrZU5ld0FjY2Vzc1Rva2VuKHJlcS51c2VyLmlkLCBVc2VyVHlwZS5EaWFyeSlcclxuXHJcbiAgICByZXMuanNvbihyZXN1bHQpXHJcbiAgfVxyXG5cclxuICByZXR1cm4gcm91dGVyXHJcbn1cclxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQXlEO0FBRTFDLFNBQVNBLGtCQUFrQixDQUFFQyxNQUFNLEdBQUcsSUFBQUMsZUFBTSxHQUFFLEVBQUU7RUFDN0Q7RUFDQUQsTUFBTSxDQUFDRSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsSUFBQUMscUJBQVksRUFBQ0MsUUFBUSxDQUFDLENBQUM7RUFDdkQ7RUFDQUosTUFBTSxDQUFDRSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsSUFBQUMscUJBQVksRUFBQ0UsU0FBUyxDQUFDLENBQUM7RUFDekQ7RUFDQUwsTUFBTSxDQUFDRSxJQUFJLENBQUMsb0JBQW9CLEVBQUVJLHFCQUFVLEVBQUUsSUFBQUgscUJBQVksRUFBQ0ksVUFBVSxDQUFDLENBQUM7RUFDdkU7RUFDQVAsTUFBTSxDQUFDUSxHQUFHLENBQUMsMEJBQTBCLEVBQUVDLHVCQUFZLEVBQUUsSUFBQU4scUJBQVksRUFBQ08sZUFBZSxDQUFDLENBQUM7RUFFbkYsZUFBZU4sUUFBUSxDQUFFTyxHQUFHLEVBQUVDLEdBQUcsRUFBRTtJQUNqQyxNQUFNQyxJQUFJLEdBQUcsSUFBQUMsNEJBQWlCLEVBQUNILEdBQUcsQ0FBQ0UsSUFBSSxFQUFFO01BQ3ZDRSxJQUFJLEVBQUVDLFlBQUcsQ0FBQ0MsTUFBTSxFQUFFLENBQUNDLFFBQVEsRUFBRTtNQUM3QkMsS0FBSyxFQUFFSCxZQUFHLENBQUNDLE1BQU0sRUFBRSxDQUFDQyxRQUFRLEVBQUU7TUFDOUJFLFFBQVEsRUFBRUosWUFBRyxDQUFDQyxNQUFNLEVBQUUsQ0FBQ0ksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDSCxRQUFRLEVBQUU7TUFDeENJLE1BQU0sRUFBRU4sWUFBRyxDQUFDQyxNQUFNLEVBQUUsQ0FBQ0MsUUFBUSxFQUFFLENBQUNLLEtBQUssQ0FBQyxHQUFHQyxlQUFDLENBQUNDLE1BQU0sQ0FBQ0MsZ0JBQVUsQ0FBQyxDQUFDO01BQzlEQyxTQUFTLEVBQUVYLFlBQUcsQ0FBQ1ksSUFBSSxFQUFFLENBQUNWLFFBQVE7SUFDaEMsQ0FBQyxDQUFDO0lBRUYsTUFBTSxJQUFBVyxnQ0FBUSxFQUFDaEIsSUFBSSxDQUFDO0lBRXBCLElBQUFpQixhQUFNLEVBQUNsQixHQUFHLENBQUM7RUFDYjtFQUVBLGVBQWVQLFNBQVMsQ0FBRU0sR0FBRyxFQUFFQyxHQUFHLEVBQUU7SUFDbEMsTUFBTTtNQUFFTyxLQUFLO01BQUVDO0lBQVMsQ0FBQyxHQUFHLElBQUFOLDRCQUFpQixFQUFDSCxHQUFHLENBQUNFLElBQUksRUFBRTtNQUN0RE0sS0FBSyxFQUFFSCxZQUFHLENBQUNDLE1BQU0sRUFBRSxDQUFDRSxLQUFLLEVBQUUsQ0FBQ0QsUUFBUSxFQUFFO01BQ3RDRSxRQUFRLEVBQUVKLFlBQUcsQ0FBQ0MsTUFBTSxFQUFFLENBQUNDLFFBQVE7SUFDakMsQ0FBQyxDQUFDO0lBRUYsTUFBTWEsTUFBTSxHQUFHLE1BQU0sSUFBQUMsaUNBQVMsRUFBQ2IsS0FBSyxFQUFFQyxRQUFRLENBQUM7SUFFL0NSLEdBQUcsQ0FBQ3FCLElBQUksQ0FBQ0YsTUFBTSxDQUFDO0VBQ2xCO0VBRUEsZUFBZXhCLFVBQVUsQ0FBRUksR0FBRyxFQUFFQyxHQUFHLEVBQUU7SUFDbkMsTUFBTSxJQUFBc0Isa0NBQVUsRUFBQ3ZCLEdBQUcsQ0FBQ3dCLElBQUksQ0FBQ0MsRUFBRSxDQUFDO0lBRTdCLElBQUFOLGFBQU0sRUFBQ2xCLEdBQUcsQ0FBQztFQUNiO0VBRUEsZUFBZUYsZUFBZSxDQUFFQyxHQUFHLEVBQUVDLEdBQUcsRUFBRTtJQUN4QyxNQUFNbUIsTUFBTSxHQUFHLElBQUFNLDJCQUFrQixFQUFDMUIsR0FBRyxDQUFDd0IsSUFBSSxDQUFDQyxFQUFFLEVBQUVFLGNBQVEsQ0FBQ0MsS0FBSyxDQUFDO0lBRTlEM0IsR0FBRyxDQUFDcUIsSUFBSSxDQUFDRixNQUFNLENBQUM7RUFDbEI7RUFFQSxPQUFPL0IsTUFBTTtBQUNmIn0=