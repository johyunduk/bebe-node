"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = authenticateRoutes;
var _express = require("express");
var _asyncHandler = _interopRequireDefault(require("@global-common/server/routes/helper/asyncHandler"));
var _authenticateController = require("@diary-server/controller/authenticate-controller");
var _joi = _interopRequireDefault(require("joi"));
var _validator = require("@global-common/utils/validator");
var _utils = require("@global-common/server/routes/helper/utils");
var _userGuard = require("@diary-server/routes/middleware/userGuard");
var _makeJwt = require("@global-common/utils/make-jwt");
var _enum = require("@global-common/constants/enum");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function authenticateRoutes(router = (0, _express.Router)()) {
  // 다이어리 사용자 회원가입
  router.post('/diary/auth/join', (0, _asyncHandler.default)(postJoin));
  // 다이어리 사용자 로그인
  router.post('/diary/auth/login', (0, _asyncHandler.default)(postLogin));
  // 다이어리 사용자 로그아웃
  router.post('/diary/auth/logout', _userGuard.diaryGuard, (0, _asyncHandler.default)(postLogout));
  // 다이어리 사용자 신규 accessToken 발급
  router.put('/diary/auth/tokenRefresh', _userGuard.reissueGuard, (0, _asyncHandler.default)(putTokenRefresh));
  async function postJoin(req, res) {
    const body = (0, _validator.validateInputData)(req.body, {
      name: _joi.default.string().required(),
      email: _joi.default.string().required(),
      password: _joi.default.string().min(8).required(),
      gender: _joi.default.string().required(),
      birthDate: _joi.default.date().required()
    });
    await (0, _authenticateController.userJoin)(body);
    (0, _utils.sendOk)(res);
  }
  async function postLogin(req, res) {
    const {
      email,
      password
    } = (0, _validator.validateInputData)(req.body, {
      email: _joi.default.string().email().required(),
      password: _joi.default.string().required()
    });
    const result = await (0, _authenticateController.userLogin)(email, password);
    res.json(result);
  }
  async function postLogout(req, res) {
    await (0, _authenticateController.userLogout)(req.user.id);
    (0, _utils.sendOk)(res);
  }
  async function putTokenRefresh(req, res) {
    const result = (0, _makeJwt.makeNewAccessToken)(req.user.id, _enum.UserType.Diary);
    res.json(result);
  }
  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhdXRoZW50aWNhdGVSb3V0ZXMiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJwb3N0IiwiYXN5bmNIYW5kbGVyIiwicG9zdEpvaW4iLCJwb3N0TG9naW4iLCJkaWFyeUd1YXJkIiwicG9zdExvZ291dCIsInB1dCIsInJlaXNzdWVHdWFyZCIsInB1dFRva2VuUmVmcmVzaCIsInJlcSIsInJlcyIsImJvZHkiLCJ2YWxpZGF0ZUlucHV0RGF0YSIsIm5hbWUiLCJKb2kiLCJzdHJpbmciLCJyZXF1aXJlZCIsImVtYWlsIiwicGFzc3dvcmQiLCJtaW4iLCJnZW5kZXIiLCJiaXJ0aERhdGUiLCJkYXRlIiwidXNlckpvaW4iLCJzZW5kT2siLCJyZXN1bHQiLCJ1c2VyTG9naW4iLCJqc29uIiwidXNlckxvZ291dCIsInVzZXIiLCJpZCIsIm1ha2VOZXdBY2Nlc3NUb2tlbiIsIlVzZXJUeXBlIiwiRGlhcnkiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZGlhcnktc2VydmVyL3JvdXRlcy9kZWZhdWx0LWxvYWQvYXV0aGVudGljYXRlLXJvdXRlcy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdleHByZXNzJ1xyXG5pbXBvcnQgYXN5bmNIYW5kbGVyIGZyb20gJ0BnbG9iYWwtY29tbW9uL3NlcnZlci9yb3V0ZXMvaGVscGVyL2FzeW5jSGFuZGxlcidcclxuaW1wb3J0IHsgdXNlckpvaW4sIHVzZXJMb2dpbiwgdXNlckxvZ291dCB9IGZyb20gJ0BkaWFyeS1zZXJ2ZXIvY29udHJvbGxlci9hdXRoZW50aWNhdGUtY29udHJvbGxlcidcclxuaW1wb3J0IEpvaSBmcm9tICdqb2knXHJcbmltcG9ydCB7IHZhbGlkYXRlSW5wdXREYXRhIH0gZnJvbSAnQGdsb2JhbC1jb21tb24vdXRpbHMvdmFsaWRhdG9yJ1xyXG5pbXBvcnQgeyBzZW5kT2sgfSBmcm9tICdAZ2xvYmFsLWNvbW1vbi9zZXJ2ZXIvcm91dGVzL2hlbHBlci91dGlscydcclxuaW1wb3J0IHsgZGlhcnlHdWFyZCwgcmVpc3N1ZUd1YXJkIH0gZnJvbSAnQGRpYXJ5LXNlcnZlci9yb3V0ZXMvbWlkZGxld2FyZS91c2VyR3VhcmQnXHJcbmltcG9ydCB7IG1ha2VOZXdBY2Nlc3NUb2tlbiB9IGZyb20gJ0BnbG9iYWwtY29tbW9uL3V0aWxzL21ha2Utand0J1xyXG5pbXBvcnQgeyBVc2VyVHlwZSB9IGZyb20gJ0BnbG9iYWwtY29tbW9uL2NvbnN0YW50cy9lbnVtJ1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gYXV0aGVudGljYXRlUm91dGVzIChyb3V0ZXIgPSBSb3V0ZXIoKSkge1xyXG4gIC8vIOuLpOydtOyWtOumrCDsgqzsmqnsnpAg7ZqM7JuQ6rCA7J6FXHJcbiAgcm91dGVyLnBvc3QoJy9kaWFyeS9hdXRoL2pvaW4nLCBhc3luY0hhbmRsZXIocG9zdEpvaW4pKVxyXG4gIC8vIOuLpOydtOyWtOumrCDsgqzsmqnsnpAg66Gc6re47J24XHJcbiAgcm91dGVyLnBvc3QoJy9kaWFyeS9hdXRoL2xvZ2luJywgYXN5bmNIYW5kbGVyKHBvc3RMb2dpbikpXHJcbiAgLy8g64uk7J207Ja066asIOyCrOyaqeyekCDroZzqt7jslYTsm4NcclxuICByb3V0ZXIucG9zdCgnL2RpYXJ5L2F1dGgvbG9nb3V0JywgZGlhcnlHdWFyZCwgYXN5bmNIYW5kbGVyKHBvc3RMb2dvdXQpKVxyXG4gIC8vIOuLpOydtOyWtOumrCDsgqzsmqnsnpAg7Iug6recIGFjY2Vzc1Rva2VuIOuwnOq4iVxyXG4gIHJvdXRlci5wdXQoJy9kaWFyeS9hdXRoL3Rva2VuUmVmcmVzaCcsIHJlaXNzdWVHdWFyZCwgYXN5bmNIYW5kbGVyKHB1dFRva2VuUmVmcmVzaCkpXHJcblxyXG4gIGFzeW5jIGZ1bmN0aW9uIHBvc3RKb2luIChyZXEsIHJlcykge1xyXG4gICAgY29uc3QgYm9keSA9IHZhbGlkYXRlSW5wdXREYXRhKHJlcS5ib2R5LCB7XHJcbiAgICAgIG5hbWU6IEpvaS5zdHJpbmcoKS5yZXF1aXJlZCgpLFxyXG4gICAgICBlbWFpbDogSm9pLnN0cmluZygpLnJlcXVpcmVkKCksXHJcbiAgICAgIHBhc3N3b3JkOiBKb2kuc3RyaW5nKCkubWluKDgpLnJlcXVpcmVkKCksXHJcbiAgICAgIGdlbmRlcjogSm9pLnN0cmluZygpLnJlcXVpcmVkKCksXHJcbiAgICAgIGJpcnRoRGF0ZTogSm9pLmRhdGUoKS5yZXF1aXJlZCgpLFxyXG4gICAgfSlcclxuXHJcbiAgICBhd2FpdCB1c2VySm9pbihib2R5KVxyXG5cclxuICAgIHNlbmRPayhyZXMpXHJcbiAgfVxyXG5cclxuICBhc3luYyBmdW5jdGlvbiBwb3N0TG9naW4gKHJlcSwgcmVzKSB7XHJcbiAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gdmFsaWRhdGVJbnB1dERhdGEocmVxLmJvZHksIHtcclxuICAgICAgZW1haWw6IEpvaS5zdHJpbmcoKS5lbWFpbCgpLnJlcXVpcmVkKCksXHJcbiAgICAgIHBhc3N3b3JkOiBKb2kuc3RyaW5nKCkucmVxdWlyZWQoKSxcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlckxvZ2luKGVtYWlsLCBwYXNzd29yZClcclxuXHJcbiAgICByZXMuanNvbihyZXN1bHQpXHJcbiAgfVxyXG5cclxuICBhc3luYyBmdW5jdGlvbiBwb3N0TG9nb3V0IChyZXEsIHJlcykge1xyXG4gICAgYXdhaXQgdXNlckxvZ291dChyZXEudXNlci5pZClcclxuXHJcbiAgICBzZW5kT2socmVzKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZnVuY3Rpb24gcHV0VG9rZW5SZWZyZXNoIChyZXEsIHJlcykge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gbWFrZU5ld0FjY2Vzc1Rva2VuKHJlcS51c2VyLmlkLCBVc2VyVHlwZS5EaWFyeSlcclxuXHJcbiAgICByZXMuanNvbihyZXN1bHQpXHJcbiAgfVxyXG5cclxuICByZXR1cm4gcm91dGVyXHJcbn1cclxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtB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